<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Etik Social - Giriş</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>

  <!-- === GİRİŞ FORMU (arayüzü sen zaten yapmıştın, bu iskelet) === -->
  <input id="username" placeholder="Kullanıcı adı">
  <input id="password" type="password" placeholder="Şifre">
  <button id="loginBtn">Giriş Yap</button>

  <div id="status" style="margin-top:10px;font-size:14px;"></div>

  <!-- === JS === -->
  <script type="module">
    /* ---------------- FIREBASE ---------------- */
    import { auth, db } from "./firebase.js";
    import {
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import {
      doc, getDoc
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    /* ---------------- ELEMENTLER ---------------- */
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const status = document.getElementById("status");

    function showStatus(msg, ok) {
      status.textContent = msg;
      status.style.color = ok ? "lime" : "red";
    }

    /* ---------------- BRUTEFORCE KORUMA ---------------- */
    const MAX_TRY = 8;
    const MAX_VERIFY = 4;
    const LOCK_DAYS = 4;

    function now() {
      return Date.now();
    }

    function isLocked() {
      const until = localStorage.getItem("lockUntil");
      return until && now() < Number(until);
    }

    function lockBrowser() {
      const until = now() + LOCK_DAYS * 24 * 60 * 60 * 1000;
      localStorage.setItem("lockUntil", until);
    }

    function getTry() {
      return Number(localStorage.getItem("loginTry") || 0);
    }

    function incTry() {
      localStorage.setItem("loginTry", getTry() + 1);
    }

    function resetTry() {
      localStorage.removeItem("loginTry");
      localStorage.removeItem("verifyCount");
    }

    function needVerify() {
      return getTry() >= MAX_TRY;
    }

    function verifyRobot() {
      let count = Number(localStorage.getItem("verifyCount") || 0);
      if (count >= MAX_VERIFY) {
        lockBrowser();
        return false;
      }
      const ok = confirm("Robot olmadığını doğrula");
      if (!ok) {
        localStorage.setItem("verifyCount", count + 1);
        return false;
      }
      return true;
    }

    async function safeLogin(loginFn) {
      if (isLocked()) {
        showStatus("Bu tarayıcı geçici olarak kilitlendi.", false);
        return;
      }

      if (needVerify()) {
        if (!verifyRobot()) {
          showStatus("Doğrulama başarısız.", false);
          return;
        }
      }

      try {
        await loginFn();
        resetTry();
        showStatus("Giriş başarılı ✅", true);
        window.location.href = "home.html";
      } catch (e) {
        incTry();
        showStatus("Kullanıcı adı veya şifre yanlış", false);
      }
    }

    /* ---------------- LOGIN ---------------- */
    loginBtn.onclick = () => {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      if (!username || !password) {
        showStatus("Boş alan bırakma", false);
        return;
      }

      safeLogin(async () => {
        // kullanıcı adı -> sahte email gibi kullanılıyor
        const fakeEmail = username + "@etik.local";

        await signInWithEmailAndPassword(auth, fakeEmail, password);

        // kullanıcı gerçekten DB'de var mı kontrol
        const snap = await getDoc(doc(db, "users", username));
        if (!snap.exists()) throw new Error("user-not-found");

        localStorage.setItem("loggedUser", username);
      });
    };
  </script>

</body>
</html>
